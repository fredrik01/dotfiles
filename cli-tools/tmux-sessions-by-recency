#!/usr/bin/env bash

# Get current session name to exclude it
current_session=$(tmux display-message -p '#S')

# List all sessions with their last attached timestamps, exclude current session and popup sessions,
# sort by last attached time (most recent first), and format for display
tmux list-sessions -F "#{session_last_attached} #{session_name}" | \
    grep -v " ${current_session}$" | \
    grep -v -- "-popup$" | \
    sort -rn | \
    while read timestamp session_name; do
        # Calculate time since last visit
        current_time=$(date +%s)
        seconds_ago=$((current_time - timestamp))

        # Skip sessions older than 24 hours
        if [ $seconds_ago -ge 86400 ]; then
            continue
        fi

        if [ $seconds_ago -lt 60 ]; then
            time_display="${seconds_ago}s ago"
        elif [ $seconds_ago -lt 3600 ]; then
            minutes_ago=$((seconds_ago / 60))
            time_display="${minutes_ago}m ago"
        else
            hours_ago=$((seconds_ago / 3600))
            time_display="${hours_ago}h ago"
        fi

        printf "%-20s %s\n" "$session_name" "$time_display"
    done | \
    fzf --reverse | \
    awk '{print $1}' | \
    xargs tmux switch-client -t